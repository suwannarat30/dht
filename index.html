<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temperature & Humidity Monitor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* โค้ด CSS ของเพื่อนเหมือนเดิมไม่เปลี่ยน */
    :root{
      --bg1:#0f2235; --bg2:#3c5570; --bg3:#a9b6c4;
      --text:#f3f7fd; --muted:rgba(255,255,255,.85);
      --panel:rgba(255,255,255,.12); --panel-2:rgba(255,255,255,.16);
      --panel-card:#eef1f5; --panel-tint:rgba(0,0,0,.06);
      --border:rgba(255,255,255,.24); --card-border:rgba(0,0,0,.08);
      --shadow:0 28px 60px rgba(8,18,32,.35);
      --lineT:#ffb870; --lineH:#7db9ff; --grid:rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0; min-height:100vh; color:var(--text); font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(1200px 900px at 100% -10%, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      display:flex; align-items:center; justify-content:center; padding:28px;
    }
    /* ... ส่วน CSS เดิมทั้งหมด ... */
  </style>
</head>
<body>
  <div class="board">
    <!-- ส่วน HTML board เดิมเหมือนเดิม -->
    <div class="bar">
      <div class="place">Temperature & Humidity Dashboard</div>
      <div class="chip" id="clock">--:--:--</div>
    </div>

    <div class="grid">
      <section class="card main">
        <div class="icon">☀️</div>
        <div>
          <div class="tempRow">
            <div id="temperature-value">--</div>
            <div class="unit">°C</div>
          </div>
          <div class="subtext">Temperature</div>
        </div>
      </section>

      <section class="side">
        <div class="card">
          <div class="row">
            <div class="label">Humidity</div>
            <div class="donut" id="humidity-donut" style="--p:0">
              <span class="num" id="humidity-value">--%</span>
            </div>
          </div>
        </div>

        <div class="card status-wrap">
          <div id="status-message">Connecting...</div>
        </div>
      </section>

      <section class="card chart-panel chart-card">
        <div class="legend">
          <span style="display:flex;align-items:center;gap:6px"><span class="dot t"></span>Temp</span>
          <span style="display:flex;align-items:center;gap:6px"><span class="dot h"></span>Humidity</span>
        </div>
        <canvas id="chart"></canvas>
      </section>

      <section class="card history">
        <h3 style="margin:0 0 10px 0; color:#2b3c54">ประวัติย้อนหลัง (MongoDB)</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>เวลา</th>
                <th>อุณหภูมิ (°C)</th>
                <th>ความชื้น (%RH)</th>
              </tr>
            </thead>
            <tbody id="history-body"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* ===== Backend polling & chart logic ===== */
    const BACKEND_BASE = "https://dht-sz2z.onrender.com"; // เปลี่ยนเป็น server ของคุณ
    const MAX_POINTS = 60;
    const series = { t: [], h: [], ts: [] };

    function setText(id, value){ const el = document.getElementById(id); if (el) el.textContent = value; }

    function updateClock(){
      const el = document.getElementById('clock'); if (!el) return;
      el.textContent = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    }
    updateClock(); setInterval(updateClock, 1000);

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    let dpi = 1;
    function resizeCanvas(){ const rect = canvas.getBoundingClientRect(); dpi = window.devicePixelRatio || 1; canvas.width=Math.round(rect.width*dpi); canvas.height=Math.round(rect.height*dpi); drawChart(1);}
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function lerp(a,b,t){ return a + (b-a)*t; }
    function niceRange(min,max){ if(min===max){min-=1; max+=1;} const pad=(max-min)*0.15; return [Math.floor(min-pad),Math.ceil(max+pad)]; }

    let anim = { fromT:[], toT:[], fromH:[], toH:[], start:0, dur:800 };
    function scheduleAnimation(){ anim.fromT=anim.toT.slice(); anim.fromH=anim.toH.slice(); anim.toT=series.t.slice(); anim.toH=series.h.slice(); anim.start=performance.now(); requestAnimationFrame(tick);}
    function tick(now){ const p=Math.min(1,(now-anim.start)/anim.dur); drawChart(p); if(p<1) requestAnimationFrame(tick);}
    function drawChart(progress=1){ /* ... เหมือนเดิม ... */ }

    function pushPoint(temp, hum, ts = Date.now()){
      series.t.push(Number(temp));
      series.h.push(Number(hum));
      series.ts.push(Number(ts));
      if(series.t.length > MAX_POINTS){ series.t.shift(); series.h.shift(); series.ts.shift(); }
      scheduleAnimation();
    }

    // โหลดประวัติจาก MongoDB แล้วเติมลงกราฟ + ตาราง
    async function loadHistory(limit = 120){
      try{
        const res = await fetch(`${BACKEND_BASE}/history?limit=${limit}`, { cache: "no-store" });
        const docs = await res.json();
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = '';

        docs.forEach(d => { const ts = new Date(d.at).getTime(); pushPoint(d.temperature, d.humidity, ts); });
        docs.forEach(d => {
          const tr = document.createElement('tr');
          const tStr = new Date(d.at).toLocaleString('th-TH',{hour12:false});
          tr.innerHTML = `<td>${tStr}</td><td>${Number(d.temperature).toFixed(1)}</td><td>${Number(d.humidity).toFixed(0)}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.error('loadHistory error:', e);}
    }

    async function fetchData(){
      try{
        const res = await fetch(`${BACKEND_BASE}/data`, { cache: "no-store" });
        const data = await res.json();
        if(data.temperature !== null){
          const t = Number(data.temperature);
          setText("temperature-value", t.toFixed(1));
          if(!isNaN(t) && data.humidity !== null){
            const ts = data.at ?? Date.now();
            pushPoint(t, Number(data.humidity), ts);
          }
        }
        if(data.humidity !== null){
          const h = Number(data.humidity);
          setText("humidity-value", `${h.toFixed(0)}%`);
          const donut = document.getElementById('humidity-donut');
          if(donut) donut.style.setProperty('--p', Math.max(0, Math.min(100, h)));
        }
        setText("status-message", "Data updated ✅");
      }catch(err){ console.error("Fetch error:", err); setText("status-message","Error fetching data ⚠️"); }
    }

    loadHistory(120).finally(()=>{ fetchData(); setInterval(fetchData, 5000); });
  </script>
</body>
</html>
